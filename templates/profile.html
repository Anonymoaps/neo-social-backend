<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Perfil | NEO</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body style="overflow-y: auto;">

    <!-- Top Nav Profile -->
    <div class="top-nav"
        style="position: sticky; top:0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000; border-bottom: 1px solid #222;">
        <a href="/" class="nav-item"
            style="font-size: 1.5em; text-decoration: none; color: white; position: relative; z-index: 1001;">‚Üê</a>
        <div style="font-weight: bold; font-size: 1.1em;">{{ user.username }} <span
                style="font-size:0.8em; color:gold;">{% if user.is_pioneer %}üî∞{% endif %}</span></div>
        <div class="nav-item" onclick="toggleSettings()" style="position: relative; z-index: 1001;"><i
                class="fas fa-ellipsis-h"></i></div>
    </div>

    <!-- Settings Menu -->
    <div id="settingsMenu"
        style="display:none; position:fixed; top:60px; right:10px; background:#111; border:1px solid #333; padding:10px; border-radius:10px; z-index:1002;">
        {% if is_me %}
        <button onclick="handleLogout()"
            style="background:transparent; border:none; color:red; font-size:1em; padding:5px 10px; cursor:pointer;">Sair
            / Logout</button>
        {% else %}
        <button onclick="alert('Report user?')"
            style="background:transparent; border:none; color:white; font-size:1em; padding:5px 10px; cursor:pointer;">Reportar</button>
        {% endif %}
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
        <div style="position:relative; display:inline-block;">
            <img src="{{ user.profile_pic }}" class="p-pic" alt="Profile">
            {% if user.is_pioneer %}
            <div class="pioneer-badge-corner" style="display:flex;">üî∞</div>
            {% endif %}
        </div>

        <div class="p-name">@{{ user.username }}</div>
        <div class="p-bio">{{ user.bio if user.bio else 'Sem bio ainda.' }}</div>

        <div class="p-stats">
            <div class="p-stat-box">
                <div class="stat-num" id="statFollowers">{{ user.followers_count }}</div>
                <div class="stat-label">Followers</div>
            </div>
            <div class="p-stat-box">
                <div class="stat-num">{{ user.following_count }}</div>
                <div class="stat-label">Following</div>
            </div>
            <div class="p-stat-box">
                <div class="stat-num">{{ likes_count }}</div>
                <div class="stat-label">Likes</div>
            </div>
        </div>

        <!-- Buttons -->
        <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
            {% if is_me %}
            <button class="primary-btn" style="width: auto; padding: 10px 30px; margin:0; font-size: 0.9em;"
                onclick="openEditProfile()">Editar Perfil</button>
            {% else %}
            {% if is_following %}
            <button id="btnFollow" class="primary-btn"
                style="width: auto; padding: 10px 40px; margin:0; font-size: 0.9em; background: #333; border: 1px solid #555;"
                onclick="toggleFollow('{{ user.username }}')">Seguindo</button>
            {% else %}
            <button id="btnFollow" class="primary-btn"
                style="width: auto; padding: 10px 40px; margin:0; font-size: 0.9em;"
                onclick="toggleFollow('{{ user.username }}')">Seguir</button>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Video Grid -->
    <div class="profile-grid">
        {% for video in videos %}
        <a href="/?video_id={{ video.id }}" class="grid-item" style="text-decoration:none;">
            <!-- Linking to home with video logic would be ideal, but user asked for /video/id logic. Main simple link is safer for now or just visual -->
            <!-- User asked for href="/video/{video_id}". Assuming this route exists or will handle it. If not, link to home -->
            <video src="{{ video.url }}"></video>
            <div
                style="position:absolute; bottom:5px; left:5px; color:white; font-size:0.8em; text-shadow:1px 1px 2px black;">
                ‚ô• {{ video.likes }}
            </div>
        </a>
        {% else %}
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #555;">
            <p>Nenhum v√≠deo ainda.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Edit Modal -->
    <div id="editProfileModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Editar Perfil</h2>
            <div class="input-group">
                <label style="font-size:0.8em; color:#aaa;">Foto URL</label>
                <input type="text" id="editPic" value="{{ user.profile_pic }}" placeholder="URL da imagem">
            </div>
            <div class="input-group">
                <label style="font-size:0.8em; color:#aaa;">Bio</label>
                <input type="text" id="editBio" value="{{ user.bio if user.bio else '' }}" placeholder="Sua bio...">
            </div>
            <button class="primary-btn" onclick="saveProfile()">Salvar</button>
            <button class="primary-btn" style="background:#333; margin-top:10px;"
                onclick="document.getElementById('editProfileModal').style.display='none'">Cancelar</button>
        </div>
    </div>

    <script>
        function openEditProfile() {
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function toggleSettings() {
            const m = document.getElementById('settingsMenu');
            m.style.display = m.style.display === 'none' ? 'block' : 'none';
        }

        async function saveProfile() {
            const bio = document.getElementById('editBio').value;
            const pic = document.getElementById('editPic').value;

            const fd = new FormData();
            fd.append('bio', bio);
            fd.append('profile_pic', pic);

            try {
                const res = await fetch('/update_profile', { method: 'POST', body: fd });
                if (res.ok) {
                    window.location.reload();
                } else {
                    alert('Erro ao atualizar');
                }
            } catch (e) { console.error(e); }
        }

        async function toggleFollow(username) {
            const btn = document.getElementById('btnFollow');
            // Optimistic Update
            const isFollowing = btn.innerText === 'Seguindo';
            if (isFollowing) {
                btn.innerText = 'Seguir';
                btn.style.background = 'linear-gradient(45deg, #FF2E63, #A020F0)';
                btn.style.border = 'none';
            } else {
                btn.innerText = 'Seguindo';
                btn.style.background = '#333';
                btn.style.border = '1px solid #555';
            }

            try {
                const res = await fetch(`/user/${username}/follow`, { method: 'POST' });
                const data = await res.json();
                document.getElementById('statFollowers').innerText = data.followers_count;

                // Re-sync button state if network update differs (optional safe-guard)
                if (data.following) {
                    btn.innerText = 'Seguindo';
                    btn.style.background = '#333';
                    btn.style.border = '1px solid #555';
                } else {
                    btn.innerText = 'Seguir';
                    btn.style.background = 'linear-gradient(45deg, #FF2E63, #A020F0)';
                    btn.style.border = 'none';
                }
            } catch (e) { console.error(e); }
        }

        async function handleLogout() {
            await fetch('/logout', { method: 'POST' });
            window.location.href = '/';
        }
    </script>
</body>

</html>
```