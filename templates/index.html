<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEO | Social Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <!-- Nav -->
    <div class="top-nav">
        <div class="nav-items">
            <div class="nav-item active" onclick="switchFeed('foryou', this)">For You</div>
            <div class="nav-item" onclick="switchFeed('following', this)">Following</div>
        </div>

        <!-- Auth Actions Container -->
        <div class="nav-actions" style="display:flex; gap:10px;">
            <!-- Logged In State (Hidden by default) -->
            <div id="loggedInActions" style="display:none; align-items:center; gap:10px;">
                <a href="/me" class="profile-icon" style="color: inherit; text-decoration: none;"><i
                        class="fas fa-user-circle" style="font-size:1.5em;"></i></a>
                <button class="btn-upload" onclick="openUpload()">+ Upload</button>
            </div>

            <!-- Guest State -->
            <button id="btnLogin" class="primary-btn" style="width:auto; padding: 5px 15px; font-size:0.9em;"
                onclick="document.getElementById('loginModal').style.display='flex'">Entrar</button>
        </div>
    </div>

    <!-- Feed -->
    <div id="feed-container">
        <div class="video-slide" style="background:#000;">
            <h3>Loading NEO...</h3>
        </div>
    </div>

    <!-- Heart FX -->
    <div id="big-heart">â™¥</div>

    <!-- Drawers/Modals -->
    <div id="commentsDrawer" class="drawer">
        <div class="drawer-header">Comments <span class="close-drawer" onclick="closeComments()">âœ•</span></div>
        <div class="comments-list" id="commentsList"></div>
        <div class="input-bar">
            <input type="text" id="commentInput" placeholder="Add comment...">
            <button type="button" class="primary-btn" id="btnPostComment" style="width:auto; padding:0 20px;"
                onclick="postComment(event)">Send</button>
        </div>
    </div>

    <div id="uploadModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Upload</h2>
            <div class="input-group"><input type="text" id="uploadTitle" placeholder="Caption"></div>
            <div class="input-group"><input type="file" id="uploadFile" accept="video/*"></div>
            <button class="primary-btn" onclick="submitUpload()" id="btnSubmitUpload">ðŸš€ Post</button>
            <button class="primary-btn" style="background:#333; margin-top:10px;"
                onclick="closeUpload()">Cancel</button>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay" style="display: flex;">
        <div class="modal-box"
            style="z-index: 9999999 !important; position: relative; pointer-events: auto !important;">

            <!-- ABAS -->
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
                <button onclick="toggleAuthMode('login')" id="tabLogin"
                    style="background:none; border:none; color:white; font-weight:bold; cursor:pointer; border-bottom: 2px solid var(--primary);">Entrar</button>
                <button onclick="toggleAuthMode('signup')" id="tabSignup"
                    style="background:none; border:none; color:#555; font-weight:bold; cursor:pointer;">Criar
                    Conta</button>
            </div>

            <!-- LOGIN BOX -->
            <div id="login-box">
                <h1>Bem-vindo</h1>
                <form onsubmit="event.preventDefault(); doLogin();">
                    <div class="input-group">
                        <input type="email" id="loginUserField" name="email" placeholder="Seu Email" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="loginPassField" name="password" placeholder="Senha" required>
                    </div>
                    <div id="loginError" style="color: #ff2e63; font-size: 0.9em; margin-bottom: 10px; display: none;">
                        Credenciais invÃ¡lidas
                    </div>
                    <button type="submit" class="primary-btn">Entrar</button>
                </form>
            </div>

            <!-- SIGNUP BOX (WIZARD) -->
            <div id="signup-box" style="display:none;">

                <!-- STEP 1: CREDENCIAIS -->
                <div id="step1">
                    <h3>Criar Conta</h3>
                    <form onsubmit="handleRegisterStep1(event)">
                        <div class="input-group"><input type="email" id="regEmail" placeholder="Email" required></div>
                        <div class="input-group"><input type="password" id="regPass" placeholder="Senha" required></div>
                        <button type="submit" class="primary-btn" id="btnStep1">PrÃ³ximo ></button>
                    </form>
                </div>

                <!-- STEP 2: CODIGO -->
                <div id="step2" style="display:none;">
                    <h3>VerificaÃ§Ã£o</h3>
                    <p style="font-size:0.8em; color:#aaa;">Enviamos um cÃ³digo para seu email.</p>
                    <form onsubmit="handleRegisterStep2(event)">
                        <div class="input-group"><input type="text" id="regCode" placeholder="CÃ³digo 6 dÃ­gitos"
                                required></div>
                        <button type="submit" class="primary-btn" id="btnStep2">Validar</button>
                    </form>
                </div>

                <!-- STEP 3: USERNAME -->
                <div id="step3" style="display:none;">
                    <h3>Sua Identidade</h3>
                    <form onsubmit="handleRegisterStep3(event)">
                        <div class="input-group"><input type="text" id="regUser" placeholder="@username_unico" required>
                        </div>
                        <button type="submit" class="primary-btn" id="btnStep3">Finalizar! ðŸš€</button>
                    </form>
                </div>

            </div>

        </div>
    </div>

    <!-- Share Toast -->
    <div id="shareToast"
        style="position:fixed; bottom:50px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; z-index:9999; display:none; border:1px solid #333;">
        Link Copiado! ðŸ“‹</div>

    <script>
        let currentUser = null;
        let currentVideoId = null;
        let lastClickTime = 0;
        let currentFeedType = 'foryou';

        async function init() {
            // Check for login errors in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('error')) {
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('loginError').style.display = 'block';
                // Clean URL
                window.history.replaceState({}, document.title, "/");
            }

            try {
                const res = await fetch('/api/me', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    if (data.user) {
                        currentUser = data;
                        document.getElementById('loginModal').style.display = 'none';
                        document.getElementById('loggedInActions').style.display = 'flex';
                        document.getElementById('btnLogin').style.display = 'none';
                    } else {
                        // User not logged in
                        document.getElementById('loggedInActions').style.display = 'none';
                        document.getElementById('btnLogin').style.display = 'block';
                    }
                }
                loadFeed('foryou');
            } catch (e) { }
        }

        /* AUTH & WIZARD LOGIC */
        function toggleAuthMode(mode) {
            const loginBox = document.getElementById('login-box');
            const signupBox = document.getElementById('signup-box');
            const tabLogin = document.getElementById('tabLogin');
            const tabSignup = document.getElementById('tabSignup');

            if (mode === 'login') {
                loginBox.style.display = 'block';
                signupBox.style.display = 'none';
                tabLogin.style.borderBottom = '2px solid var(--primary)';
                tabLogin.style.color = 'white';
                tabSignup.style.borderBottom = 'none';
                tabSignup.style.color = '#555';
            } else {
                loginBox.style.display = 'none';
                signupBox.style.display = 'block';
                tabLogin.style.borderBottom = 'none';
                tabLogin.style.color = '#555';
                tabSignup.style.borderBottom = '2px solid var(--primary)';
                tabSignup.style.color = 'white';
            }
        }

        async function doLogin() {
            const email = document.getElementById('loginUserField').value;
            const pass = document.getElementById('loginPassField').value;
            if (!email || !pass) return;

            const fd = new FormData();
            fd.append('email', email);
            fd.append('password', pass);

            try {
                const res = await fetch('/login', { method: 'POST', body: fd, redirect: 'follow' });
                if (res.redirected) {
                    if (res.url.includes('error')) {
                        document.getElementById('loginError').style.display = 'block';
                    } else {
                        window.location.href = res.url;
                    }
                } else if (res.ok) {
                    window.location.reload();
                }
            } catch (e) { console.error(e); }
        }

        async function handleRegisterStep1(e) {
            e.preventDefault();
            const btn = document.getElementById('btnStep1');
            const originalText = btn.innerText;
            btn.innerText = "Enviando..."; btn.disabled = true;

            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;

            try {
                const fd = new FormData(); fd.append('email', email); fd.append('password', pass);
                const res = await fetch('/auth/register', { method: 'POST', body: fd });

                if (!res.ok) {
                    const errorText = await res.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        alert("Erro no servidor: " + (errorJson.detail || errorJson.message));
                    } catch (e) {
                        alert("Erro CrÃ­tico no Servidor: " + errorText);
                    }
                    return;
                }

                const data = await res.json();

                if (data.status === 'success') {
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                } else {
                    alert("Erro: " + data.message);
                }
            } catch (err) {
                alert("Erro de conexÃ£o: " + err);
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }

        async function handleRegisterStep2(e) {
            e.preventDefault();
            const btn = document.getElementById('btnStep2');
            const originalText = btn.innerText;
            btn.innerText = "Verificando..."; btn.disabled = true;

            const email = document.getElementById('regEmail').value;
            const code = document.getElementById('regCode').value;

            try {
                const fd = new FormData(); fd.append('email', email); fd.append('code', code);
                const res = await fetch('/auth/verify', { method: 'POST', body: fd });
                const data = await res.json();

                if (data.status === 'success') {
                    document.getElementById('step2').style.display = 'none';
                    document.getElementById('step3').style.display = 'block';
                } else {
                    alert("CÃ³digo invÃ¡lido ou expirado.");
                }
            } catch (err) {
                alert("Erro de conexÃ£o: " + err);
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }

        async function handleRegisterStep3(e) {
            e.preventDefault();
            const btn = document.getElementById('btnStep3');
            btn.innerText = "Criando..."; btn.disabled = true;

            const email = document.getElementById('regEmail').value;
            const user = document.getElementById('regUser').value;

            try {
                const fd = new FormData(); fd.append('email', email); fd.append('username', user);
                const res = await fetch('/auth/set-username', { method: 'POST', body: fd });
                const data = await res.json();

                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert("Erro: " + data.message);
                    btn.innerText = "Tentar Novamente"; btn.disabled = false;
                }
            } catch (err) {
                alert("Erro fatal: " + err);
                btn.disabled = false;
            }
        }


        /* FEED LOGIC */
        function switchFeed(type, el) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            currentFeedType = type;
            loadFeed(type);
        }

        async function loadFeed(type) {
            const c = document.getElementById('feed-container');
            // c.innerHTML = '<div class="video-slide"><h3>Loading...</h3></div>'; // Optional spin
            try {
                const res = await fetch(`/feed?type=${type}`);
                const vids = await res.json();
                c.innerHTML = '';

                if (vids.length === 0) {
                    const msg = type === 'following'
                        ? '<h3>Siga pessoas para ver conteÃºdo aqui! ðŸ‘¥</h3>'
                        : '<h3>Seja o primeiro a postar! ðŸš€</h3>';
                    c.innerHTML = `<div class="video-slide" style="flex-direction:column; color:#888;"><h1>ðŸ‘»</h1>${msg}</div>`;
                    return;
                }

                vids.forEach(v => {
                    const s = document.createElement('div');
                    s.className = 'video-slide';
                    s.innerHTML = `
                        <video src="${v.url}" loop playsinline onclick="handleVideoClick(this, '${v.id}')"></video>
                        <div class="overlay">
                            <div class="video-info">
                                <div class="author-badge" onclick="window.location.href='/user/${v.author}'" ${!v.author ? 'style="pointer-events:none; opacity:0.7"' : ''}>
                                    <img src="${v.author_pic || 'https://ui-avatars.com/api/?background=random'}" class="author-pic">
                                    <span class="username">@${v.author || 'AnÃ´nimo'}</span>
                                    ${v.author_is_pioneer ? '<span class="pioneer-tag">ðŸ”°</span>' : ''}
                                </div>
                                <p class="desc">${v.title}</p>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="action-btn ${v.user_has_liked ? 'liked' : ''}" id="like-btn-${v.id}" onclick="toggleLike('${v.id}')">
                                <div class="icon">â™¥</div><span class="count">${v.likes}</span>
                            </button>
                            <button class="action-btn" onclick="openComments('${v.id}')">
                                <div class="icon">ðŸ’¬</div><span class="count">${v.comments_count}</span>
                            </button>
                            <button class="action-btn" onclick="shareVideo('${v.id}')">
                                <div class="icon">â†ª</div><span class="count">Share</span>
                            </button>
                        </div>`;
                    c.appendChild(s);
                });
                setupObserver();
            } catch (e) { c.innerHTML = '<div class="video-slide">Error loading feed</div>'; }
        }

        function handleVideoClick(v, id) {
            const now = new Date().getTime();
            if (now - lastClickTime < 300) {
                document.getElementById('big-heart').classList.remove('animate');
                void document.getElementById('big-heart').offsetWidth;
                document.getElementById('big-heart').classList.add('animate');
                if (!document.getElementById(`like-btn-${id}`).classList.contains('liked')) toggleLike(id);
            } else {
                if (v.paused) v.play(); else v.pause();
            }
            lastClickTime = now;
        }

        function setupObserver() {
            const obs = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    const v = e.target.querySelector('video');
                    if (e.isIntersecting) { v.currentTime = 0; v.play().catch(() => { }); }
                    else v.pause();
                });
            }, { threshold: 0.6 });
            document.querySelectorAll('.video-slide').forEach(s => obs.observe(s));
        }

        async function toggleLike(id) {
            if (!currentUser) { document.getElementById('loginModal').style.display = 'flex'; return; }
            const btn = document.getElementById(`like-btn-${id}`);
            const isLiked = btn.classList.contains('liked');
            btn.classList.toggle('liked');
            let count = parseInt(btn.querySelector('.count').innerText);
            btn.querySelector('.count').innerText = isLiked ? count - 1 : count + 1;
            await fetch(`/toggle_like/${id}`, { method: 'POST' });
        }

        function shareVideo(id) {
            const url = window.location.origin + '/video/' + id; // Mock URL
            navigator.clipboard.writeText(url).then(() => {
                const t = document.getElementById('shareToast');
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 2000);
            });
        }

        /* COMMENTS */
        async function openComments(id) {
            currentVideoId = id;
            document.getElementById('commentsDrawer').classList.add('open');
            const res = await fetch(`/comments/${id}`);
            const list = await res.json();
            const div = document.getElementById('commentsList');
            div.innerHTML = '';
            list.forEach(c => {
                div.innerHTML += `
                    <div class="comment-item">
                        <img src="${c.profile_pic || 'https://ui-avatars.com/api/?background=random'}" class="comment-avatar">
                        <div>
                            <div style="font-weight:bold; color:#aaa;">${c.username || 'AnÃ´nimo'} ${c.is_pioneer ? 'ðŸ”°' : ''}</div>
                            <div>${c.text}</div>
                        </div>
                    </div>`;
            });
        }
        function closeComments() { document.getElementById('commentsDrawer').classList.remove('open'); }
        async function postComment(e) {
            // "Nuclear Fix": Prevent default just in case, though type="button" helps
            if (e) e.preventDefault();

            const btn = document.getElementById('btnPostComment'); // Force ID selection for safety
            if (!currentUser) { document.getElementById('loginModal').style.display = 'flex'; return; }
            const txt = document.getElementById('commentInput').value;
            if (!txt) return;

            // UI Lockdown
            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerText = "Enviando...";

            try {
                const res = await fetch('/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_id: currentVideoId, text: txt })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.status === "success") {
                        window.location.reload(); // Success!
                    } else {
                        alert("Erro: " + (data.message || "Falha desconhecida"));
                        throw new Error(data.message);
                    }
                } else {
                    alert("Erro ao enviar comentÃ¡rio (Server Error)");
                    throw new Error("Server Error");
                }
            } catch (err) {
                console.error(err);
                // Re-enable only on error
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        /* UPLOAD */
        function openUpload() { document.getElementById('uploadModal').style.display = 'flex'; }
        function closeUpload() { document.getElementById('uploadModal').style.display = 'none'; }
        async function submitUpload() {
            const t = document.getElementById('uploadTitle').value;
            const f = document.getElementById('uploadFile').files[0];
            if (!f) return;
            const b = document.getElementById('btnSubmitUpload');
            b.innerText = "Uploading..."; b.disabled = true;
            const fd = new FormData(); fd.append('title', t); fd.append('file', f);
            await fetch('/upload', { method: 'POST', body: fd });
            b.innerText = "Post"; b.disabled = false;
            closeUpload(); loadFeed('foryou');
        }

        // Stop Propagation for Nav Items to prevent video pauses
        document.querySelectorAll('.profile-icon, .nav-item, .btn-upload, #btnLogin').forEach(item => {
            item.addEventListener('click', (e) => e.stopPropagation());
        });

        init();
    </script>
</body>

</html>